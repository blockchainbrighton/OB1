<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OB1 #1 - Audional Art</title><style>body{background-color:#000000;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}img {width: auto;height: auto;max-width: 60%;max-height: 80vh;object-fit: contain;aspect-ratio: 1 / 1;}
</style></head><body>
<img id="OB1_Image" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD... shortened for brevity">
<audio id="audionalData" loop data-audionalSampleName="808 Kick Drum">
<source src="data:audio/wav;base64,UklGRk6GAQB... shortened for brevity">
Your browser does not support the audio element.
</audio>
<script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    let bpm = 78;
    let beatDurationSeconds = 60 / bpm;

    let isLooping = false;
    let audioBuffer = null;
    let nextNoteTime = audioContext.currentTime;
    let attackFadeDuration = 0.01; // Initial attack fade duration in seconds, adjustable
    let tailFadeDuration = 0.001; // Initial tail fade duration in seconds, adjustable

    const gainNode = audioContext.createGain();
    gainNode.connect(audioContext.destination);

    // Function to update BPM and recalculate beat duration
    // Modified updateBPM function to restart playback with new BPM
    function updateBPM(newBPM) {
        bpm = newBPM;
        beatDurationSeconds = 60 / bpm;
        console.log(`Updated BPM to ${bpm}, beatDurationSeconds to ${beatDurationSeconds}`);
        restartPlaybackIfNeeded();
    }

    // New function to restart playback if it's currently running
    function restartPlaybackIfNeeded() {
        if (isLooping) {
            stopAudioPlayback();
            playAudioBuffer();
        }
    }

    async function fetchAndDecodeAudio(elementId) {
        const audioElement = document.getElementById(elementId);
        const sourceElement = audioElement.querySelector('source');
        const audioSrc = sourceElement ? sourceElement.src : audioElement.src;

        try {
            const response = await fetch(audioSrc);
            const arrayBuffer = await response.arrayBuffer();
            audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
        } catch (error) {
            console.error("Error fetching or decoding audio data:", error);
        }
    }

    function scheduleNextNote() {
        if (!isLooping || !audioBuffer) return;

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(gainNode);

        gainNode.gain.cancelScheduledValues(nextNoteTime);
        // Apply attack fade
        gainNode.gain.setValueAtTime(0.001, nextNoteTime);
        gainNode.gain.linearRampToValueAtTime(1, nextNoteTime + attackFadeDuration);

        // Schedule the note to start at nextNoteTime
        source.start(nextNoteTime);

        // Apply tail fade if the sample is longer than the beat duration
        if (audioBuffer.duration > beatDurationSeconds) {
            const crossFadeStartTime = nextNoteTime + beatDurationSeconds - tailFadeDuration;
            gainNode.gain.linearRampToValueAtTime(0.001, crossFadeStartTime);
        }

        nextNoteTime += beatDurationSeconds; // Schedule the next note

        const delayUntilNextNote = Math.max(nextNoteTime - audioContext.currentTime, 0) * 1000;
        setTimeout(scheduleNextNote, delayUntilNextNote);
    }

    // Adjustments to the playAudioBuffer and stopAudioPlayback functions as needed
    function playAudioBuffer() {
        if (!isLooping) {
            isLooping = true;
            nextNoteTime = audioContext.currentTime; // Reset nextNoteTime to now
            scheduleNextNote(); // Begin scheduling with the new BPM
        }
    }

    function stopAudioPlayback() {
        isLooping = false;
        // You may need additional logic here to stop the current playback immediately
        // For example, stopping the currently playing BufferSource nodes.
    }


    document.getElementById("OB1_Image").addEventListener("click", async () => {
        console.log("Click detected...");
        if (!audioBuffer) {
            await fetchAndDecodeAudio("audionalData");
        }
        if (isLooping) {
            stopAudioPlayback();
        } else {
            playAudioBuffer();
        }
    });

    document.addEventListener('bpmChange', (event) => {
        const adjustment = event.detail.adjustment;
        // Assuming bpm is your global BPM variable
        bpm += adjustment;
        console.log(`BPM adjusted to ${bpm}. Recalculating beat duration...`);
        // Recalculate beatDurationSeconds and adjust scheduling as needed
    });

    document.addEventListener('multiplierChange', (event) => {
        const multiplier = event.detail.multiplier;
        // Assuming scheduleMultiplier is your global scheduling multiplier variable
        scheduleMultiplier *= multiplier;
        console.log(`Scheduling multiplier adjusted to ${scheduleMultiplier}. Adjusting playback scheduling...`);
        // Adjust playback scheduling as needed
    });

</script>
<script src="OB1_ActiveTab_Hotkeys.js"></script>
</body>
</html>
